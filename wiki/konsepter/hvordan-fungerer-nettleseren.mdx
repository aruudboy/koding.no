import { RelevantLinks } from "../../src/components/RelevantLinks/RelevantLinks.tsx";

# Hvordan lastes en nettside?

> Basert p친 [Populating the page: how browsers work - MDN](https://developer.mozilla.org/en-US/docs/Web/Performance/How_browsers_work#Populating_the_page:_how_browsers_work).

Denne artikkelen satser p친 친 gi deg en oversikt over hvordan en nettside faktisk laster innhold.
Dette er kjempenyttig kunnskap 친 ha n친r du skal optimalisere nettsider for ytelse.

## 1. Navigering

Det f칮rste steget for 친 laste inn en nettside er navigasjon. Dette kan skje p친 flere forskjellige m친ter, typisk sett:

- Bruker skriver inn en URL i adressefeltet
- Bruker klikker p친 en lenke
- Bruker trykker p친 frem/tilbake-knappen i nettleseren

N친r nettleseren har en URL, m친 den finne ut hvilken server den skal sende en foresp칮rsel til. Dette gj칮res ved 친 sl친 opp domenenavnet i **DNS** (Domain Name System).

## 2. DNS lookup

N친r nettleseren har URL-en, m친 den finne ut hvilken IP-adresse den skal sende en foresp칮rsel til. Dette gj칮res ved 친 sl친 opp domenenavnet i DNS.

En DNS server sin jobb er 친 ta imot et **`domene`**

:::info Eksempel
`example.com`
:::

og gi tilbake en IP-adresse

:::info Eksempel
`93.184.216.34`
:::

Nettleseren trenger IP-adressen for 친 kunne sende [foresp칮rseler](./server-og-klient#foresp칮rsel) til riktig server.

:::tip
Nettleseren m친 gj칮re en DNS lookup for hver eneste ressurs som skal lastes inn p친 siden fra et nytt domene.
Dette inkluderer bilder, CSS-filer, JavaScript-filer, osv. Her er det mulig 친 spare tid for brukeren som utvikler ved 친 redusere antall domener som brukes p친 en side.
:::

## 3. TCP handshake

F칮r nettleseren kan be om innhold fra en server, m친 den opprette en **TCP-tilkobling** med serveren.

Dette gj칮res ved bruk av 3 trinn:

```mermaid

sequenceDiagram
    participant Client
    participant Server

    Client->>Server: Hei, kan jeg f친 opprette en TCP-tilkobling?
    Server->>Client: Ja, det kan du
    Client->>Server: Takk, da er vi klare til 친 sende data
```

### Hvorfor trenger vi TCP?

TCP er en del av det som kalles **transportlaget** i nettverksarkitekturen.
TCP s칮rger for at data blir sendt i riktig rekkef칮lge, og at det blir sendt p친 nytt dersom
det blir 칮delagt eller mistet p친 veien. Dette er viktig for 친 kunne sende data p친litelig over internett.

Disse 3 trinnene kalles en **TCP handshake**, og m친 gj칮res for hver eneste foresp칮rsel som nettleseren sender til en server.

## 4. TLS negotiation

Hvis nettstedet bruker HTTPS, m친 nettleseren og serveren ogs친 forhandle om en **TLS-tilkobling**.
Denne "dialogen" produserer et **TLS-sertifikat** som nettleseren bruker for 친 bekrefte at serveren er den den utgir seg for 친 v칝re.

<RelevantLinks
  videos={[
    {
      title:
        "Transport Layer Security (TLS) - Computerphile",
      url: "https://youtu.be/0TLDTodL7Lc?t=578",
    },
  ]}
/>

### Hvorfor trenger vi TLS?

TLS er viktig for 친 forhindre at en tredjepart kan lese eller endre p친 data som blir sendt mellom nettleseren og serveren.

## 5. Respons

P친 dette punktet har nettleseren gjort **8 rundturer** til serveren, og har enda ikke begynt 친 laste innhold.
Men n친 som nettleseren har en TCP- og TLS-tilkobling, kan den endelig sende en **foresp칮rsel** til serveren.

Nettleseren sender endelig en [`GET` foresp칮rsel](./server-og-klient#foresp칮rsel) til serveren for 친 be om innholdet p친 siden. Serveren svarer med en **respons**:

```html
<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8" />
    <title>My simple page</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="myscript.js"></script>
  </head>
  <body>
    <h1 class="heading">My Page</h1>
    <p>
      A paragraph with a
      <a href="https://example.com/about">link</a>
    </p>
    <div>
      <img src="myimage.jpg" alt="image description" />
    </div>
    <script src="anotherscript.js"></script>
  </body>
</html>
```

## 6. Parsing

N친 som nettleseren har f친tt responsen fra serveren, kan den lese innholdet og begynne 친 bygge
opp sin egne interne representasjon av siden (DOM & CSSOM) slik at den kan vise den til brukeren.

<RelevantLinks
  documentation={[
    {
      title: "How browsers work - Parsing (MDN)",
      url: "https://developer.mozilla.org/en-US/docs/Web/Performance/How_browsers_work#parsing",
    },
  ]}
/>

## 7. Rendering

:::info [SNL](https://snl.no/rendering_-_IT)

> _Rendering_ - prosessen som konverterer en datamodell til et bilde som kan vises p친 en skjerm

:::

N친r nettleseren har bygget opp sin interne representasjon av siden, kan den begynne 친 vise den til brukeren.
Denne prosessen blir brytt opp i flere steg:

- **Style** - Nettleseren beregner hvilke CSS-regler som skal gjelde for hvert eneste element p친 siden.
- **Layout** - Nettleseren beregner hvor p친 siden hver eneste element skal vises.
- **Paint** - Nettleseren tegner elementene p친 skjermen.
- **Composite** - Nettleseren setter sammen alle elementene til en ferdig side.

<RelevantLinks
  documentation={[
    {
      title: "Why are some animations slow? (web.dev)",
      url: "https://web.dev/animations-overview/",
    },
  ]}
/>

## 8. Interaktivitet

Siden er enda ikke interaktiv 游땸. Dette er p친 grunn av at nettsiden inkluderer Javascript-filer som ikke er _deferred_ eller _async_.
Da m친 nettleseren stoppe renderingen, og vente p친 at Javascript-filene blir lastet inn og parset.

:::tip
Det er derfor nyttig 친 laste inn Javascript-filer p친 slutten av `<body>`-elementet, og bruke [`defer` eller `async`-attributtet](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/script#attributes),
slik at bruker ikke m친 vente p친 at Javascript-filene blir lastet inn f칮r siden blir interaktiv.

I eksempelet over, vil `myscript.js` bli lastet inn f칮r resten av `<body>` elementet rendres, siden den kommer f칮rst i HTML-filen, og ikke er _deferred_.
:::

S친 snart nettleseren har lastet inn og parset Javascript-filene, kan den endelig vise den interaktive siden til brukeren.

Nettleseren m친 enda prosessere brukerens interaksjon med siden, og oppdatere den interne representasjonen av siden, og deretter rendre den p친 nytt.
